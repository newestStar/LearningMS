{% if get_chapters(course.name) | length %}
<div class="course-home-outline">
    <div class="course-home-headings">
        {{ _("Course Content") }}
    </div>
    {% for chapter in get_chapters(course.name) %}
    <div class="">
        <div class="chapter-title" data-target="#{{ get_slugified_chapter_title(chapter.title) }}"
        data-toggle="collapse" aria-expanded="false">
            {% if not course.edit_mode %}
            <img class="chapter-icon" src="/assets/lms/icons/chevron-right.svg">
            {% endif %}
            <div class="w-100 chapter-title-main" {% if course.edit_mode %} contenteditable="true" {% endif %} >{{ chapter.title }}</div>
        </div>

        <div class="chapter-content collapse navbar-collapse" id="{{ get_slugified_chapter_title(chapter.title) }}">

            {% if chapter.description or course.edit_mode %}
            <div {% if course.edit_mode %} contenteditable="true" {% endif %} class="chapter-description
            {% if not course.edit_mode %} mx-8 mb-2 {% endif %} "
            data-placeholder="{{ _('Short Description') }}">{{ chapter.description }}</div>
            {% endif %}

            {% if course.edit_mode %}
            <button class="btn btn-sm btn-secondary d-block btn-save-chapter mt-2 mb-8"> {{ _('Save') }} </button>
            {% endif %}

            {% set is_instructor = is_instructor(course.name) %}
            <div class="lessons">

                {% for lesson in get_lessons(course.name, chapter) %}
                {% set active = membership.current_lesson == lesson.name %}
                <div class="lesson-info {% if active and not course.edit_mode %} active-lesson {% endif %}">

                {% if membership or lesson.include_in_preview %}
                <a class="lesson-links" href="{{ get_lesson_url(course.name, lesson.number) }}{{course.query_parameter}}"
                    data-course="{{ course.name }}">
                    <svg class="icon icon-sm mr-2">
                        <use class="" href="#{{ lesson.icon }}">
                    </svg>
                    <span>{{ lesson.title }}</span>
                    {% if membership %}
                    <svg class="icon icon-sm lesson-progress-tick {{ get_progress(course.name, lesson.name) != 'Complete' and 'hide' }}">
                        <use class="" href="#icon-green-check">
                    </svg>
                    {% endif %}

                </a>

                {% elif is_instructor and not lesson.include_in_preview %}
                <a class="lesson-links"
                    title="This lesson is not available for preview. As you are the Instructor of the course only you can see it."
                    href="{{ get_lesson_url(course.name, lesson.number) }}{{course.query_parameter}}"
                    data-course="{{ course.name }}">

                    <svg class="icon icon-sm mr-2">
                        <use class="" href="#icon-lock">
                    </svg>
                    <div>{{ lesson.title }}</div>
                </a>

                {% else %}
                <div class="no-preview" title="This lesson is not available for preview" data-course="{{ course.name }}">
                    <div class="lesson-links">
                    <svg class="icon icon-sm mr-2">
                        <use class="" href="#icon-lock-gray">
                    </svg>
                    <div>{{ lesson.title }}</div>
                    </div>
                </div>
                {% endif %}

                </div>
                {% endfor %}

            </div>
        </div>
    </div>
    {% endfor %}

    <div>
        <button class="btn btn-md btn-secondary btn-chapter" data-index=" {{ chapters | length + 1 }} "> {{ _("Add Chapter") }} </button>
    </div>
</div>

<!-- No Preview Modal -->
{{ widgets.NoPreviewModal(course=course) }}

{% elif course.edit_mode and course.name %}
<div class="course-home-outline">
    <div class="course-home-headings">
      {{ _("Course Content") }}
    </div>
    <div>
        <button class="btn btn-md btn-secondary btn-chapter" data-index="1"> {{ _("Add Chapter") }} </button>
    </div>
</div>
{% endif %}

<script>

frappe.ready(() => {

  expand_the_active_chapter();

  $(".chapter-title").unbind().click((e) => {
    rotate_chapter_icon(e);
  });

  $(".no-preview").click((e) => {
    show_no_preview_dialog(e);
  });

});

const expand_the_first_chapter = () => {
  let elements = $(".course-home-outline .collapse");
  elements.each((i, element) => {
    if (i < 1) {
      show_section(element);
      return false;
    }
  });
};

const expand_the_active_chapter = () => {

  /* Find anchor matching the URL for course details page */
  let selector = $(`a[href="${decodeURIComponent(window.location.pathname)}"]`).parent();
  if (!selector.length) {
    selector = $(`a[href^="${decodeURIComponent(window.location.pathname)}"]`).parent();
  }
  if (selector.length && $(".course-details-page").length) {
    $(".lesson-info").removeClass("active-lesson");
    $(".lesson-info").each((i, elem) => {
      let href = $(elem).find("use").attr("href");
      href.endsWith("blue") && $(elem).find("use").attr("href", href.substring(0, href.length - 5));
    })

    selector.addClass("active-lesson");

    show_section(selector.parent().parent());
  }

  /* For course home page */
  else if ($(".active-lesson").length) {
    selector = $(".active-lesson")
    show_section(selector.parent().parent());
  }

  /* If no active chapter then exapand the first chapter */
  else {
    expand_the_first_chapter();
  }
};

const show_section = (element) => {
  $(element).addClass("show");
  $(element).siblings(".chapter-title").children(".chapter-icon").css("transform", "rotate(90deg)");
  $(element).siblings(".chapter-title").attr("aria-expanded", true);
};

const rotate_chapter_icon = (e) => {
  let icon = $(e.currentTarget).children(".chapter-icon");
  if (icon.css("transform") == "none") {
    icon.css("transform", "rotate(90deg)");
  } else {
    icon.css("transform", "none");
  }
};

const show_no_preview_dialog = (e) => {
    $("#no-preview-modal").modal("show");
};

</script>
